{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
	<h1 class="text-2xl font-semibold mb-4">Portfolio ‚Äî {{ user_obj.first_name }} {{ user_obj.last_name }}</h1>

	<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
		<div class="card bg-base-200 shadow-sm p-4">
			<div class="text-sm text-muted mb-1">Peel Balance</div>
			<div class="text-2xl font-bold"><span id="cash-balance" data-balance="{{ balance }}">{{ balance }} üçå</span></div>
		</div>
		<div class="card bg-base-200 shadow-sm p-4">
			<div class="text-sm text-muted mb-1">Stocks Total</div>
			<div class="text-2xl font-bold"><span id="stocks-total">{{ stocks_total }}</span> üçå</div>
		</div>
		<div class="card bg-primary text-primary-content shadow-sm p-4">
			<div class="text-sm opacity-80 mb-1">Total Worth</div>
			<div class="text-2xl font-bold"><span id="portfolio-worth">{{ portfolio_worth }}</span> üçå</div>
		</div>
	</div>

	<h2 class="text-xl font-medium mb-4">Holdings</h2>

	{% if holdings %}
		<div class="hidden md:block overflow-x-auto">
			<table class="table w-full">
				<thead>
					<tr>
						<th class="text-left">Name</th>
						<th class="text-left">Symbol</th>
						<th class="text-left">Trend</th>
						<th class="text-right">Price</th>
						<th class="text-right">Quantity</th>
						<th class="text-right">Total</th>
						<th class="text-right">Sell</th>
					</tr>
				</thead>
				<tbody>
					{% for h in holdings %}
					<tr data-symbol="{{ h.symbol }}">
						<td>{{ h.name }}</td>
						<td>{{ h.symbol }}</td>
						<td><span class="portfolio-direction" data-symbol="{{ h.symbol }}">
							{% if h.direction == 1 %}
								<span class="text-green-600" title="Up">&#9650;</span>
							{% elif h.direction == -1 %}
								<span class="text-red-600" title="Down">&#9660;</span>
							{% else %}
								<span class="text-gray-500" title="No change">‚Äî</span>
							{% endif %}
						</span></td>
						<td class="text-right"><span class="portfolio-price" data-symbol="{{ h.symbol }}">{{ h.price }}</span> üçå</td>
						<td class="text-right"><span class="portfolio-shares" data-symbol="{{ h.symbol }}">{{ h.shares }}</span></td>
						<td class="text-right font-semibold"><span class="portfolio-total" data-symbol="{{ h.symbol }}">{{ h.total }}</span> üçå</td>
						<td class="text-right">
							<form class="sell-form flex items-center justify-end gap-2" data-symbol="{{ h.symbol }}">
								<input type="number" min="1" value="1" class="input input-sm input-bordered w-20 sell-amount" data-symbol="{{ h.symbol }}" />
								<button type="submit" class="btn btn-sm btn-secondary sell-btn" data-symbol="{{ h.symbol }}">Sell</button>
								<span class="sell-msg text-sm text-red-600" data-symbol="{{ h.symbol }}"></span>
							</form>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<div class="md:hidden space-y-4">
			{% for h in holdings %}
			<div class="card bg-base-100 shadow-md p-4" data-symbol="{{ h.symbol }}">
				<div class="flex justify-between items-start mb-3">
					<div>
						<div class="font-semibold text-lg">{{ h.name }}</div>
						<div class="text-sm text-muted">{{ h.symbol }}</div>
					</div>
					<div class="flex items-center gap-2">
						<span class="portfolio-direction" data-symbol="{{ h.symbol }}">
							{% if h.direction == 1 %}
								<span class="text-green-600 text-xl" title="Up">&#9650;</span>
							{% elif h.direction == -1 %}
								<span class="text-red-600 text-xl" title="Down">&#9660;</span>
							{% else %}
								<span class="text-gray-500" title="No change">‚Äî</span>
							{% endif %}
						</span>
					</div>
				</div>
				
				<div class="grid grid-cols-2 gap-3 mb-3">
					<div>
						<div class="text-xs text-muted">Price</div>
						<div class="font-mono text-lg"><span class="portfolio-price" data-symbol="{{ h.symbol }}">{{ h.price }}</span> üçå</div>
					</div>
					<div>
						<div class="text-xs text-muted">Quantity</div>
						<div class="font-mono text-lg"><span class="portfolio-shares" data-symbol="{{ h.symbol }}">{{ h.shares }}</span></div>
					</div>
					<div class="col-span-2">
						<div class="text-xs text-muted">Total Value</div>
						<div class="font-mono text-xl font-bold"><span class="portfolio-total" data-symbol="{{ h.symbol }}">{{ h.total }}</span> üçå</div>
					</div>
				</div>

				<form class="sell-form" data-symbol="{{ h.symbol }}">
					<div class="flex gap-2">
						<input type="number" min="1" value="1" class="input input-bordered flex-1 sell-amount" data-symbol="{{ h.symbol }}" placeholder="Quantity" />
						<button type="submit" class="btn btn-secondary sell-btn" data-symbol="{{ h.symbol }}">Sell</button>
					</div>
					<span class="sell-msg text-sm mt-2 block text-red-600" data-symbol="{{ h.symbol }}"></span>
				</form>
			</div>
			{% endfor %}
		</div>
	{% else %}
		<p>You don't own any stocks yet.</p>
	{% endif %}

<dialog id="loan-modal" class="modal">
	<div class="modal-box">
		<h3 class="font-bold text-lg">üçå Banana Bank Emergency Loan</h3>
		<p class="py-4">Your portfolio is looking a bit light! The Banana Bank offers you a <strong>$20 emergency loan</strong>.</p>
		<div class="alert alert-warning">
			<span>üìù Repay with 25% interest ($25 total) automatically when your balance is above $50.</span>
		</div>
		<div class="modal-action">
			<button class="btn" onclick="document.getElementById('loan-modal').close()">No Thanks</button>
			<button class="btn btn-primary" onclick="takeLoan()">Accept Loan</button>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<div id="loan-repaid-toast" class="toast toast-top toast-center hidden">
	<div class="alert alert-success">
		<span id="loan-repaid-message">Loan repaid successfully!</span>
	</div>
</div>

<script>
(function(){
	const POLL_INTERVAL = 5000;
	const TICKER_URL = '/api/ticker/';
	const SELL_URL = '/api/sell/';
	const LOAN_STATUS_URL = '/api/loan/status/';
	const TAKE_LOAN_URL = '/api/loan/take/';

	let loanModalShown = false;

	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	async function checkLoanStatus() {
		try {
			const res = await fetch(LOAN_STATUS_URL, { cache: 'no-store' });
			if (!res.ok) return;
			const data = await res.json();
			
			if (data.auto_repaid) {
				const toast = document.getElementById('loan-repaid-toast');
				const message = document.getElementById('loan-repaid-message');
				message.textContent = `Loan of $${data.repaid_amount} automatically repaid! New balance: $${data.new_balance}`;
				toast.classList.remove('hidden');
				setTimeout(() => toast.classList.add('hidden'), 5000);
				
				const balanceEl = document.getElementById('cash-balance');
				if (balanceEl) {
					balanceEl.dataset.balance = data.new_balance;
					balanceEl.textContent = data.new_balance.toFixed(2) + ' üçå';
				}
			}
			
			if (data.eligible_for_loan && !loanModalShown) {
				loanModalShown = true;
				document.getElementById('loan-modal').showModal();
			}
		} catch(e) {
			console.error('Error checking loan status:', e);
		}
	}

	window.takeLoan = async function() {
		try {
			const res = await fetch(TAKE_LOAN_URL, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': getCookie('csrftoken')
				}
			});
			
			const data = await res.json();
			
			if (res.ok) {
				document.getElementById('loan-modal').close();
				
				const balanceEl = document.getElementById('cash-balance');
				if (balanceEl) {
					balanceEl.dataset.balance = data.new_balance;
					balanceEl.textContent = data.new_balance.toFixed(2) + ' üçå';
				}
				
				const toast = document.getElementById('loan-repaid-toast');
				const message = document.getElementById('loan-repaid-message');
				message.textContent = `Loan of $${data.loan_given} approved! Remember to repay $${data.to_repay} when your balance exceeds $50.`;
				toast.classList.remove('hidden');
				setTimeout(() => toast.classList.add('hidden'), 6000);
				
				fetchAndUpdate();
			} else {
				alert(data.error || 'Failed to process loan');
			}
		} catch(e) {
			alert('Error processing loan: ' + e.message);
		}
	};

	async function fetchAndUpdate(){
		try{
			const res = await fetch(TICKER_URL, { cache: 'no-store' });
			if(!res.ok) return;
			const data = await res.json();
			const map = Object.create(null);
			data.forEach(it => { map[it.symbol] = it; });

		let stocksTotal = 0;
		const processedSymbols = new Set();

		const holdings = document.querySelectorAll('tr[data-symbol], .card[data-symbol]');
		
		holdings.forEach(elem => {
			const sym = elem.dataset.symbol;
			if (!sym || processedSymbols.has(sym)) return;
			
			const item = map[sym];
			const sharesEl = elem.querySelector('.portfolio-shares[data-symbol="' + sym + '"]');
			const shares = sharesEl ? parseInt(sharesEl.textContent, 10) : 0;

			if(item && shares > 0){
				const priceEl = elem.querySelector('.portfolio-price[data-symbol="' + sym + '"]');
				const dirEl = elem.querySelector('.portfolio-direction[data-symbol="' + sym + '"]');
				const totalEl = elem.querySelector('.portfolio-total[data-symbol="' + sym + '"]');

				const price = (typeof item.price === 'number') ? item.price : parseFloat(item.price);
				if(priceEl) priceEl.textContent = price.toFixed(2);

				if(dirEl){
					if(item.direction > 0) dirEl.innerHTML = '<span class="text-green-600 text-xl" title="Up">&#9650;</span>';
					else if(item.direction < 0) dirEl.innerHTML = '<span class="text-red-600 text-xl" title="Down">&#9660;</span>';
					else dirEl.innerHTML = '<span class="text-gray-500" title="No change">‚Äî</span>';
				}

				const total = Math.round((price * shares + Number.EPSILON) * 100) / 100;
				if(totalEl) totalEl.textContent = total.toFixed(2);
				
				stocksTotal += total;
				processedSymbols.add(sym);
			}
		});
		
		const stocksTotalEl = document.getElementById('stocks-total');
		if(stocksTotalEl) stocksTotalEl.textContent = stocksTotal.toFixed(2);

			const balanceEl = document.getElementById('cash-balance');
			const balance = balanceEl ? parseFloat(balanceEl.dataset.balance || balanceEl.textContent || '0') : 0;
			const pfEl = document.getElementById('portfolio-worth');
			if(pfEl) pfEl.textContent = (Math.round((balance + stocksTotal + Number.EPSILON) * 100) / 100).toFixed(2);

		}catch(e){
		}
	}

	async function sellOne(symbol, amount, msgEl){
		if(!symbol) return;
		amount = parseInt(amount, 10) || 0;
		if(amount < 1){
			if(msgEl) { msgEl.textContent = 'Enter a quantity of 1 or more.'; }
			return;
		}

		try{
			const res = await fetch(SELL_URL, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': getCookie('csrftoken')
				},
				body: JSON.stringify({ symbol, amount })
			});

			const body = await res.json();
			if(!res.ok){
				if(msgEl) { msgEl.textContent = body.error || 'Sell failed'; }
				setTimeout(()=> { if(msgEl) msgEl.textContent = ''; }, 4000);
				return;
			}

			const balanceEl = document.getElementById('cash-balance');
			if(balanceEl){
				balanceEl.dataset.balance = body.balance;
				balanceEl.textContent = Number(body.balance).toFixed(2) + ' üçå';
			}

		const elements = document.querySelectorAll('[data-symbol="' + symbol + '"]');
		elements.forEach(elem => {
			const sharesEl = elem.querySelector('.portfolio-shares[data-symbol="' + symbol + '"]');
			const totalEl = elem.querySelector('.portfolio-total[data-symbol="' + symbol + '"]');
			if(body.holding && body.holding.shares !== undefined){
				const shares = parseInt(body.holding.shares, 10) || 0;
				if(shares <= 0){
					elem.parentNode.removeChild(elem);
				} else {
					if(sharesEl) sharesEl.textContent = shares;
					const priceEl = elem.querySelector('.portfolio-price[data-symbol="' + symbol + '"]');
					const price = priceEl ? parseFloat(priceEl.textContent || '0') : 0;
					const total = Math.round((price * shares + Number.EPSILON) * 100) / 100;
					if(totalEl) totalEl.textContent = total.toFixed(2);
				}
			}
		});			
			if(msgEl) { msgEl.textContent = 'Sold'; setTimeout(()=> { if(msgEl) msgEl.textContent = ''; }, 2000); }
			fetchAndUpdate();

		}catch(e){
			if(msgEl) { msgEl.textContent = 'Sell failed (network)'; setTimeout(()=> { if(msgEl) msgEl.textContent = ''; }, 4000); }
		}
	}

	document.addEventListener('DOMContentLoaded', function(){
		fetchAndUpdate();
		checkLoanStatus();
		setInterval(fetchAndUpdate, POLL_INTERVAL);
		setInterval(checkLoanStatus, POLL_INTERVAL);

		document.querySelectorAll('.sell-form').forEach(form => {
			form.addEventListener('submit', function(evt){
				evt.preventDefault();
				const symbol = form.dataset.symbol;
				const amountInput = form.querySelector('.sell-amount[data-symbol="' + symbol + '"]');
				const msgEl = form.querySelector('.sell-msg[data-symbol="' + symbol + '"]');
				const amount = amountInput ? amountInput.value : 0;
				sellOne(symbol, amount, msgEl);
			});
		});
	});
})();
</script>

</div>
{% endblock %}