{% extends "base.html" %}

{% block content %}

<div class="min-h-screen flex items-start justify-center p-6">
	<div class="w-full max-w-3xl">
		<div class="card bg-base-200 shadow-md p-6">
			<h2 class="text-2xl font-bold mb-4">Market — Choose a stock</h2>

			<div class="mb-4">
				<label class="block text-sm font-medium text-base-content mb-2">Stock</label>
				<select id="stock-select" class="select select-bordered w-full">
					<!-- options populated by JS -->
				</select>
			</div>

			<div id="stock-card" class="p-4 rounded-lg bg-base-100 shadow-sm">
				<div class="flex items-baseline justify-between">
					<div>
						<div id="stock-name" class="text-lg font-semibold">&nbsp;</div>
						<div id="stock-symbol" class="text-sm text-muted">&nbsp;</div>
					</div>
					<div class="text-right">
						<div class="text-sm text-muted">Current Price</div>
						<div id="stock-price" class="text-2xl font-mono">&nbsp;</div>
					</div>
				</div>

				<div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
					<div class="col-span-2">
						<label class="block text-sm text-muted mb-1">Quantity</label>
						<input id="buy-amount" type="number" min="1" value="1" class="input input-bordered w-full" />
					</div>
					<div>
						<button id="buy-btn" class="btn btn-primary w-full">Buy</button>
					</div>
				</div>

				<div id="buy-msg" class="mt-3 text-sm"></div>
			</div>

		</div>
	</div>
</div>

<script>
// Simple client-side logic to populate stocks dropdown and poll for updates
(function(){
		const listUrl = '/api/stocks/';
	const detailUrl = (s) => `/api/stocks/${encodeURIComponent(s)}/`;
		const buyUrl = '/api/buy/';
	const select = document.getElementById('stock-select');
	const nameEl = document.getElementById('stock-name');
	const symbolEl = document.getElementById('stock-symbol');
	const priceEl = document.getElementById('stock-price');
		const amountEl = document.getElementById('buy-amount');
		const buyBtn = document.getElementById('buy-btn');
		const buyMsg = document.getElementById('buy-msg');

		let msgTimeout = null;

		function scheduleClear(){
			if(msgTimeout) clearTimeout(msgTimeout);
			msgTimeout = setTimeout(()=>{
				buyMsg.textContent = '';
				buyMsg.className = 'mt-3 text-sm';
				msgTimeout = null;
			}, 5000);
		}

	let currentSymbol = null;
	let pollHandle = null;

	function fmtPrice(p){ return `$${(p).toFixed(2)}`; }

	async function fetchStocks(){
		try{
			const res = await fetch(listUrl, {cache: 'no-store'});
			if(!res.ok) throw new Error('Failed to load stocks');
			const stocks = await res.json();
			populateSelect(stocks);
		}catch(e){
			console.error('fetchStocks', e);
		}
	}

	function populateSelect(stocks){
		// if options already same as stocks, skip replacing to preserve selection
		const existing = Array.from(select.options).map(o => o.value);
		const newSymbols = stocks.map(s => s.symbol);
		if(JSON.stringify(existing) === JSON.stringify(newSymbols)) return;

		select.innerHTML = '';
		stocks.forEach((s, idx) => {
			const opt = document.createElement('option');
			opt.value = s.symbol;
			opt.textContent = `${s.name} (${s.symbol})`;
			select.appendChild(opt);
		});

		// default to first stock
		if(!currentSymbol && stocks.length>0){
			select.value = stocks[0].symbol;
			currentSymbol = stocks[0].symbol;
			updateDetail(currentSymbol);
		}
	}

	async function updateDetail(symbol){
		if(!symbol) return;
		try{
			const res = await fetch(detailUrl(symbol), {cache: 'no-store'});
			if(!res.ok) throw new Error('Failed to load stock detail');
			const d = await res.json();
			nameEl.textContent = d.name || '';
			symbolEl.textContent = d.symbol || '';
			priceEl.textContent = d.price!==undefined ? fmtPrice(d.price) : '';
		}catch(e){
			console.error('updateDetail', e);
		}
	}


		// CSRF helper
		function getCookie(name) {
			let cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				const cookies = document.cookie.split(';');
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim();
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}

		async function buyCurrent(){
			const symbol = currentSymbol;
			const amount = parseInt(amountEl.value, 10) || 0;
			buyMsg.textContent = '';
			if(!symbol) return;
			if(amount < 1){ buyMsg.textContent = 'Enter a quantity of 1 or more.'; buyMsg.className = 'mt-3 text-sm text-red-700'; scheduleClear(); return; }

			try{
				const res = await fetch(buyUrl, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': getCookie('csrftoken')
					},
					body: JSON.stringify({ symbol, amount })
				});

				const body = await res.json();
						if(!res.ok){
							buyMsg.textContent = body.error || 'Purchase failed';
							buyMsg.className = 'mt-3 text-sm text-red-700';
							scheduleClear();
							return;
						}

				// success
				buyMsg.textContent = `Bought ${body.holding.shares} ${body.holding.symbol} — new balance $${Number(body.balance).toFixed(2)}`;
				buyMsg.className = 'mt-3 text-sm text-green-800';
				scheduleClear();
				// refresh details to show updated price if any
				updateDetail(symbol);
				}catch(e){
					console.error('buyCurrent', e);
					buyMsg.textContent = 'Purchase failed (network)';
					buyMsg.className = 'mt-3 text-sm text-red-700';
					scheduleClear();
				}
		}

		buyBtn.addEventListener('click', ()=> buyCurrent());

	select.addEventListener('change', (e)=>{
		const s = e.target.value;
		currentSymbol = s;
		updateDetail(s);
		// reset poll to update this symbol regularly
		if(pollHandle) clearInterval(pollHandle);
		pollHandle = setInterval(()=> updateDetail(currentSymbol), 5000);
	});

	// initial load
	document.addEventListener('DOMContentLoaded', ()=>{
		fetchStocks();
		// start polling current symbol if any
		pollHandle = setInterval(()=>{
			if(currentSymbol) updateDetail(currentSymbol);
			else fetchStocks();
		}, 5000);
	});

})();
</script>

{% endblock %}