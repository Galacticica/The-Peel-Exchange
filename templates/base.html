{% load static django_vite %}

<!DOCTYPE html>
<html lang="en" class="h-full" data-theme="lemonade">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/trix/1.3.1/trix.js"></script>
    <style>
        trix-toolbar [data-trix-button-group="block-tools"] { 
            display: none;
        }
        
        trix-toolbar [data-trix-button-group="file-tools"] { 
            display: none;
        }
      </style>

      {% vite_hmr_client %}
    {% vite_asset "src/app.js" %}
    {% vite_asset "src/ticker.js" %}

    <title>The Peel Exchange</title>
</head>
<body class="min-h-screen">
    <div class="drawer">
        <input id="site-drawer" type="checkbox" class="drawer-toggle" />

        <div class="drawer-content flex flex-col min-h-screen">
            <header class="p-4 bg-base-100 border-b">
                <div class="max-w-6xl mx-auto flex items-center justify-between">
                    <div class="flex items-center">
                        <label for="site-drawer" class="btn btn-ghost btn-circle" aria-label="Open menu">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                        </label>
                    </div>

                    <div class="flex-1 flex justify-center">
                        <a href="{% url 'market-home' %}" class="inline-flex items-center">
                            <img src="{% static 'logo.png' %}" alt="The Peel Exchange" class="h-16" />
                        </a>
                    </div>

                    <div class="flex items-center">
                        <a href="{% url 'market-portfolio' %}" class="btn btn-primary">Portfolio</a>
                    </div>
                </div>
            </header>

            <div class="w-full bg-base-200 border-t border-b overflow-hidden">
                <div id="site-ticker" class="relative h-12 w-full">
                    <div id="ticker-track" class="absolute left-0 top-0 h-12"></div>
                </div>
            </div>

            <div id="news-bar" class="w-full bg-base-200 border-t border-b p-2 text-sm text-center text-muted">
                <span id="news-bar-text">Loading latest market news...</span>
            </div>

            <main class="flex-grow max-w-6xl mx-auto w-full p-6">
                {% block content %}{% endblock %}
            </main>
<footer class="footer sm:footer-horizontal bg-warning text-primary-content items-center p-4">
  <aside class="grid-flow-col items-center">
    <img src="{% static 'square_logo.png' %}" alt="Footer Logo" class="h-12">
    <p>Copyright ¬© 2025 - All right reserved</p>
  </aside>
    </footer>
        </div>

        {% if user.is_superuser %}
        <div class="drawer drawer-end">
            <input id="admin-drawer" type="checkbox" class="drawer-toggle" />
            
            <div class="drawer-content">
                <label for="admin-drawer" class="btn btn-circle btn-warning fixed bottom-6 right-6 text-2xl shadow-lg z-50 cursor-pointer">
                    üêí
                </label>
            </div>

            <div class="drawer-side z-50">
                <label for="admin-drawer" class="drawer-overlay"></label>
                <aside class="w-80 bg-base-100 p-6 min-h-screen shadow-xl">
                    <div class="mb-4 flex items-center justify-between">
                        <h3 class="text-xl font-bold">üêí Monkey Panel</h3>
                        <label for="admin-drawer" class="btn btn-ghost btn-sm">‚úï</label>
                    </div>

                    <div class="space-y-4">
                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h4 class="card-title text-sm">Force Market Event</h4>
                                <div class="form-control mb-2">
                                    <label class="label">
                                        <span class="label-text">Select Stock</span>
                                    </label>
                                    <select id="admin-stock-select" class="select select-bordered select-sm w-full">
                                        <option value="">Loading stocks...</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <button onclick="forceEvent('minor')" class="btn btn-sm btn-info w-full">
                                        Slight Impact Event
                                    </button>
                                    <button onclick="forceEvent('moderate')" class="btn btn-sm btn-warning w-full">
                                        Moderate Impact Event
                                    </button>
                                    <button onclick="forceEvent('major')" class="btn btn-sm btn-error w-full">
                                        Major Impact Event
                                    </button>
                                    <button onclick="forceEvent('severe')" class="btn btn-sm btn-error w-full bg-red-700 hover:bg-red-800 border-red-700">
                                        Severe Impact Event
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h4 class="card-title text-sm">Add Money</h4>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Select User</span>
                                    </label>
                                    <select id="admin-user-select" class="select select-bordered select-sm w-full">
                                        <option value="">Loading users...</option>
                                    </select>
                                </div>
                                <div class="form-control mt-2">
                                    <label class="label">
                                        <span class="label-text">Amount ($)</span>
                                    </label>
                                    <input type="number" id="admin-money-amount" placeholder="1000" class="input input-bordered input-sm" step="100" min="0" value="1000">
                                </div>
                                <button onclick="addMoney()" class="btn btn-sm btn-success w-full mt-2">
                                    üí∞ Add Money to Account
                                </button>
                            </div>
                        </div>

                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h4 class="card-title text-sm">Set Stock Price</h4>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Select Stock</span>
                                    </label>
                                    <select id="admin-price-stock-select" class="select select-bordered select-sm w-full">
                                        <option value="">Loading stocks...</option>
                                    </select>
                                </div>
                                <div class="form-control mt-2">
                                    <label class="label">
                                        <span class="label-text">New Price ($)</span>
                                    </label>
                                    <input type="number" id="admin-stock-price" placeholder="10.00" class="input input-bordered input-sm" step="0.01" min="0.01" value="10.00">
                                </div>
                                <button onclick="setStockPrice()" class="btn btn-sm btn-primary w-full mt-2">
                                    üí≤ Set Price
                                </button>
                            </div>
                        </div>

                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h4 class="card-title text-sm">Market-Wide Events</h4>
                                <div class="space-y-2">
                                    <button onclick="triggerMarketEvent('boom')" class="btn btn-sm btn-success w-full">
                                        üåü Golden Peel Boom (+25-50%)
                                    </button>
                                    <button onclick="triggerMarketEvent('crisis')" class="btn btn-sm btn-error w-full">
                                        üí• Bruised Peel Crisis (-25-50%)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h4 class="card-title text-sm">Current Status</h4>
                                <div class="text-xs space-y-1">
                                    <p><strong>User:</strong> {{ user.get_full_name }}</p>
                                    <p><strong>Balance:</strong> ${{ user.balance|floatformat:2 }}</p>
                                    <p><strong>Superuser:</strong> ‚úì</p>
                                </div>
                            </div>
                        </div>

                        <div id="admin-feedback" class="alert hidden" role="alert">
                            <span id="admin-feedback-text"></span>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <script>
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function showAdminFeedback(message, isError = false) {
                const feedback = document.getElementById('admin-feedback');
                const feedbackText = document.getElementById('admin-feedback-text');
                
                feedback.classList.remove('hidden', 'alert-success', 'alert-error');
                feedback.classList.add(isError ? 'alert-error' : 'alert-success');
                feedbackText.textContent = message;
                
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 5000);
            }

            async function loadUsers() {
                try {
                    const response = await fetch('/api/admin/users/');
                    const data = await response.json();
                    
                    const select = document.getElementById('admin-user-select');
                    select.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.name} - $${user.balance}`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            }

            async function loadStocks() {
                try {
                    const response = await fetch('/api/stocks/');
                    const data = await response.json();
                    
                    const select = document.getElementById('admin-stock-select');
                    select.innerHTML = '';
                    
                    data.forEach(stock => {
                        const option = document.createElement('option');
                        option.value = stock.symbol;
                        option.textContent = `${stock.symbol} - ${stock.name} ($${stock.price})`;
                        select.appendChild(option);
                    });
                    
                    const priceSelect = document.getElementById('admin-price-stock-select');
                    priceSelect.innerHTML = '';
                    
                    data.forEach(stock => {
                        const option = document.createElement('option');
                        option.value = stock.symbol;
                        option.textContent = `${stock.symbol} - ${stock.name} ($${stock.price})`;
                        option.dataset.currentPrice = stock.price;
                        priceSelect.appendChild(option);
                    });
                    
                    priceSelect.addEventListener('change', function() {
                        const selectedOption = priceSelect.options[priceSelect.selectedIndex];
                        if (selectedOption && selectedOption.dataset.currentPrice) {
                            document.getElementById('admin-stock-price').value = selectedOption.dataset.currentPrice;
                        }
                    });
                    
                    if (priceSelect.options.length > 0) {
                        document.getElementById('admin-stock-price').value = priceSelect.options[0].dataset.currentPrice || '10.00';
                    }
                } catch (error) {
                    console.error('Error loading stocks:', error);
                }
            }

            document.getElementById('admin-drawer')?.addEventListener('change', function(e) {
                if (e.target.checked) {
                    loadUsers();
                    loadStocks();
                }
            });

            async function forceEvent(impactLevel) {
                const stockSymbol = document.getElementById('admin-stock-select').value;
                
                if (!stockSymbol) {
                    showAdminFeedback('Please select a stock', true);
                    return;
                }
                
                try {
                    const response = await fetch('/api/admin/force-event/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 
                            impact_level: impactLevel,
                            stock_symbol: stockSymbol
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        showAdminFeedback(`Event applied: ${data.event} ‚Üí ${data.stock}`);
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        showAdminFeedback(data.error || 'Failed to apply event', true);
                    }
                } catch (error) {
                    showAdminFeedback('Error: ' + error.message, true);
                }
            }

            async function addMoney() {
                const userId = document.getElementById('admin-user-select').value;
                const amount = parseFloat(document.getElementById('admin-money-amount').value);
                
                if (!userId) {
                    showAdminFeedback('Please select a user', true);
                    return;
                }
                
                if (!amount || amount <= 0) {
                    showAdminFeedback('Please enter a valid amount', true);
                    return;
                }

                try {
                    const response = await fetch('/api/admin/add-money/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 
                            user_id: userId,
                            amount: amount 
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        showAdminFeedback(`Added $${amount} to ${data.user_name}. New balance: $${data.new_balance}`);
                        setTimeout(() => {
                            loadUsers();
                            window.location.reload();
                        }, 1500);
                    } else {
                        showAdminFeedback(data.error || 'Failed to add money', true);
                    }
                } catch (error) {
                    showAdminFeedback('Error: ' + error.message, true);
                }
            }

            async function setStockPrice() {
                const stockSymbol = document.getElementById('admin-price-stock-select').value;
                const price = parseFloat(document.getElementById('admin-stock-price').value);
                
                if (!stockSymbol) {
                    showAdminFeedback('Please select a stock', true);
                    return;
                }
                
                if (!price || price <= 0) {
                    showAdminFeedback('Please enter a valid price', true);
                    return;
                }

                try {
                    const response = await fetch('/api/admin/set-price/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 
                            stock_symbol: stockSymbol,
                            price: price 
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        showAdminFeedback(`${data.stock} price set to $${data.new_price}`);
                        setTimeout(() => {
                            loadStocks();
                            window.location.reload();
                        }, 1500);
                    } else {
                        showAdminFeedback(data.error || 'Failed to set price', true);
                    }
                } catch (error) {
                    showAdminFeedback('Error: ' + error.message, true);
                }
            }

            async function triggerMarketEvent(eventType) {
                const eventNames = {
                    'boom': 'Golden Peel Boom',
                    'crisis': 'Bruised Peel Crisis'
                };
                
                const confirmMessage = eventType === 'boom' 
                    ? 'Trigger Golden Peel Boom? All stocks will increase by 25-50%!'
                    : 'Trigger Bruised Peel Crisis? All stocks will decrease by 25-50%!';
                
                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    const response = await fetch('/api/admin/market-event/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 
                            event_type: eventType
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        showAdminFeedback(`${eventNames[eventType]} activated! ${data.stocks_affected} stocks affected.`);
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        showAdminFeedback(data.error || 'Failed to trigger event', true);
                    }
                } catch (error) {
                    showAdminFeedback('Error: ' + error.message, true);
                }
            }
        </script>
        {% endif %}

        <div class="drawer-side">
            <label for="site-drawer" class="drawer-overlay"></label>
            <aside class="w-64 bg-base-200 p-4">
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Menu</h3>
                    <label for="site-drawer" class="btn btn-ghost btn-sm">‚úï</label>
                </div>
                <nav class="menu">
                    <ul>
                        <li><a href="{% url 'market-home' %}">Market</a></li>
                        <li><a href="{% url 'market-portfolio' %}">Portfolio</a></li>
                        <li><a href="{% url 'market-leaderboard' %}">Leaderboard</a></li>
                    </ul>
                </nav>
            </aside>
        </div>
    </div>
    
</body>
</html>
